<?php
	if($_POST['base'] == 'true'){
		include '../../conexion.php';		
		$conexion = conectarse_server();			
	}else{
		include '../../conexion.php';		
		$conexion = conectarse_pruebas();			
	}
	
	date_default_timezone_set('America/Guayaquil');
	$fecha = date('Y-m-d H:i:s', time());
	$fecha_larga = date('His', time());		
	$lista = array();		
	$ruc = '1091732935001';	
	$inicio = $_POST['inicio'];
	$corte = $_POST['corte'];

	$sql = "SELECT CPM.NUMEROPRESTAMO,
		   CC.NUMEROCLIENTE,
		   PP.NOMBREUNIDO,
		   CAST(CPCC.NUMEROCUOTA AS nvarchar(3)) + '/' + CAST(CPM.NUMEROCUOTAS AS nvarchar(3)) CUOTAS,	   
		   (SELECT SUM(CPCC1.VALORCALCULADO - CPCC1.VALORCOBRADO)
		   FROM FBS_CARTERA.PRESTAMOCOMPONENTE_CARTERA CPCC1
		   INNER JOIN FBS_CARTERA.COMPONENTE_CARTERA_TASA CCCT1 ON CCCT1.SECUENCIALCOMPONENTECARTERA = CPCC1.SECUENCIALCOMPONENTECARTERA
		   WHERE CPCC1.SECUENCIALPRESTAMO = CPM.SECUENCIAL
		   AND CPCC1.NUMEROCUOTA = CPCC.NUMEROCUOTA) 
			+
		   (SELECT SUM(CPCC1.VALORCALCULADO - CPCC1.VALORCOBRADO)
		   FROM FBS_CARTERA.PRESTAMOCOMPONENTE_CARTERA CPCC1
		   INNER JOIN FBS_CARTERA.COMPONENTE_CARTERA_CAPITAL CCCT1 ON CCCT1.SECUENCIALCOMPONENTECARTERA = CPCC1.SECUENCIALCOMPONENTECARTERA
		   WHERE CPCC1.SECUENCIALPRESTAMO = CPM.SECUENCIAL
		   AND CPCC1.NUMEROCUOTA = CPCC.NUMEROCUOTA) VALOR,	
		   TP.NUMEROTELEFONO TELEFONO,   		   
		   CEP.NOMBRE ESTADOPRESTAMO,
		   CONVERT(VARCHAR(10),CPM.FECHAVENCIMIENTO,105) VENCIMIENTO,	   
		   ISNULL((SELECT SUM(CPCC1.VALORCALCULADO - CPCC1.VALORCOBRADO)
				FROM FBS_CARTERA.PRESTAMOCOMPONENTE_CARTERA CPCC1
				WHERE CPCC1.SECUENCIALPRESTAMO = CPM.SECUENCIAL
				AND CPCC1.CODIGOESTADOPRESTAMOCOMPONENTE = 'V'),0) VALORVENCIDO	
	FROM FBS_CARTERA.PRESTAMOMAESTRO CPM
	INNER JOIN FBS_CARTERA.PRESTAMOCOMPONENTE_CARTERA CPCC ON CPM.SECUENCIAL = CPCC.SECUENCIALPRESTAMO
	INNER JOIN FBS_CARTERA.COMPONENTE_CARTERA_CAPITAL CCCC ON CCCC.SECUENCIALCOMPONENTECARTERA = CPCC.SECUENCIALCOMPONENTECARTERA
	INNER JOIN FBS_CARTERA.PRESTAMOCLIENTE CPC ON CPC.SECUENCIALPRESTAMO = CPM.SECUENCIAL
	INNER JOIN FBS_CLIENTES.CLIENTE CC ON CC.SECUENCIAL = CPC.SECUENCIALCLIENTE
	INNER JOIN FBS_PERSONAS.PERSONA PP ON CC.SECUENCIALPERSONA = PP.SECUENCIAL
	INNER JOIN FBS_CARTERA.ESTADOPRESTAMO CEP ON CPM.CODIGOESTADOPRESTAMO = CEP.CODIGO
	INNER JOIN FBS_SEGURIDADES.USUARIO SU ON SU.CODIGO = CPM.CODIGOUSUARIOOFICIAL
	INNER JOIN FBS_PERSONAS.TELEFONOPERSONA TP ON TP.SECUENCIALPERSONA = PP.SECUENCIAL
	INNER JOIN FBS_GENERALES.TIPOTELEFONO TT ON TP.CODIGOTIPOTELEFONO = TT.CODIGO
	WHERE CPC.ESPRINCIPAL = '1'
	AND CPCC.CODIGOESTADOPRESTAMOCOMPONENTE <> 'C'
	AND CPCC.FECHAVENCIMIENTO BETWEEN '$inicio' AND '$corte'
	AND CPM.CODIGOESTADOPRESTAMO <> 'Z'
	AND CPM.SECUENCIALOFICINA = '2'
	AND TT.CODIGO = 'C'	
	ORDER BY CPM.NUMEROPRESTAMO ASC";

	
	$sql = sqlsrv_query($conexion,$sql);					
	
	while ($row = sqlsrv_fetch_object($sql))   {		
        $lista[] = $row->NUMEROPRESTAMO; 
        $lista[] = $row->NUMEROCLIENTE;
		$lista[] = $row->NOMBREUNIDO;
		$lista[] = $row->CUOTAS;
		$lista[] = number_format($row->VALOR, 2, '.', '');
		$lista[] = $row->TELEFONO;
		$lista[] = $row->ESTADOPRESTAMO;
		$lista[] = $row->VENCIMIENTO;
		$lista[] = number_format($row->VALORVENCIDO, 2, '.', '');        	                
	}	
    echo $lista = json_encode($lista);	    
	
	sqlsrv_close( $conexion );
	

?>